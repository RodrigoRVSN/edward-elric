trigger:
- master

pool:
  vmImage: ubuntu-latest

jobs:
- job: BuildAndTest
  displayName: 'Build and Test'
  steps:
  - script: |
      mkdir -p '$(GOPATH)/bin'
      mkdir -p '$(GOPATH)/pkg'
      mkdir -p '$(modulePath)'
      shopt -s extglob
      shopt -s dotglob
      mv !(gopath) '$(modulePath)'
      echo '##vso[task.prependpath]$(GOBIN)'
      echo '##vso[task.prependpath]$(GOROOT)/bin'
    displayName: '‚öíÔ∏è Set up the Go workspace'

  - script: |
      go version
      go get -v -t -d ./...
      if [ -f Gopkg.toml ]; then
          curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
          dep ensure
      fi
      go build -v .
    workingDirectory: '$(modulePath)'
    displayName: 'üì¶ Get dependencies, then build'

  - script: |
      go test
    workingDirectory: '$(modulePath)'
    displayName: 'üß™ Run tests'

- job: DeployToAzure
  displayName: 'Deploy to Azure App Service'
  dependsOn: BuildAndTest
  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.x'
      addToPath: true
  
  - script: |
      az webapp up --runtime GO:1.19 --os linux --sku B1 --name edward-elric
    displayName: 'üöÄ Deploy to Azure App Service'